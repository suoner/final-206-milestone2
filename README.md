# Milestone 2: Concept Extraction from Clinical Notes

## Name: Su Oner

---

## 1. Project Summary

This project addresses the core requirements of Milestone 2 by investigating the efficacy of using unstructured clinical note data to identify a patient cohort. The central objective is to compare this text-based methodology against a "gold standard" cohort derived from structured Electronic Health Record (EHR) data in Milestone 1.

The analysis focuses on patients with **Vitiligo** and their treatment with **Ruxolitinib (Opzelura)**. By applying SQL-based pattern matching to a random sample of clinical notes, this project extracts a new cohort and generates a comparative demographic profile ("Table 1"). The resulting analysis highlights the significant challenges and potential insights of working with unstructured clinical text, directly addressing the central research question of Milestone 2: which data source is more reliable for cohort identification?

---

## 2. Files in This Repository

| File Name | Description |
| :--- | :--- |
| `initial_cohort_query.sql` | SQL script used to generate the initial, full cohort of all 5,209 patients with a Vitiligo diagnosis from the structured OMOP database. |
| `final_analysis.sql` |  A single, comprehensive SQL script that performs the complete analysis for this milestone. It executes the patient sampling, performs pattern matching on the notes, and generates the final pivoted demographic comparison table. |
| `cohort_results.csv` | A CSV file containing the `person_id`s for the 5,209 patients in the full Vitiligo cohort, generated by `initial_cohort_query.sql`. |
| `notes.csv` | A CSV file containing a random sample of 200 clinical notes extracted from the RAE, used as the input for the pattern-matching analysis. |
| `README.md` | This documentation file, summarizing the project's methodology, results, and conclusions. |

---

## 3. Methodology & Subset Justification

The analysis for this milestone was designed to compare two distinct methods of cohort identification.

### Milestone 1: The "Gold Standard" Structured Cohort

The baseline for comparison is the cohort of **317 patients** identified in Milestone 1. This group was derived entirely from structured data by querying the OMOP database for patients with both a diagnosis code for Vitiligo (`CONDITION_OCCURRENCE` table) and a corresponding prescription record for Ruxolitinib (`DRUG_EXPOSURE` table) from the initial population of **5,209 patients**. This represents a high-fidelity cohort of patients who verifiably received the drug.

### Milestone 2: The Unstructured Notes-Based Cohort

The core of this milestone was to replicate cohort identification using unstructured data.

* **Patient Population**: The analysis began with the broader cohort of 5,209 patients with a Vitiligo diagnosis.
* **Subset Selection & Justification**: From this population, a random sample of **200 patients** was selected for analysis. This subset was justified on two grounds:
    1.  **Computational Feasibility**: Analyzing the complete note history for over 5,000 patients is computationally intensive. A 200-patient sample provides a manageable dataset for the scope of this project.
    2.  **Methodological Demonstration**: A random sample is sufficient to demonstrate the core challenges and differences between structured and unstructured data analysis, which is the primary goal of this milestone. All note types were included to ensure a broad search.
* **Pattern Matching**: The analysis was performed entirely in SQL within the RAE. A text search using the `LIKE` operator was applied to the notes of the sampled patients to find any mentions of the keywords `opzelura` or `ruxolitinib`.
* **Demographic Analysis**: The final demographic "Table 1" was also generated directly in SQL, using conditional aggregation to create a pivoted view comparing the two cohorts.

---

## 4. Results & Analysis

### Pattern Matching Summary

From the random sample of 200 patients, the SQL-based pattern matching identified **17 unique patients** with at least one mention of the drug in their clinical notes. This immediately highlights a significant discrepancy compared to the 317 patients identified via structured data.

### Comparative Demographic Analysis

The most significant finding of this project is the **dramatic difference in the age distribution** between the cohort identified from notes and the "gold standard" cohort from Milestone 1.

**Table 1: Age Distribution Comparison (% of Cohort)**

| Age Range | M1 Structured Cohort (n=317 of 5,209) | M2 Notes Cohort (n=17 of 200) |
| :-------- | :------------------------------------ | :------------------------------ |
| 0-9       | 7.33%                                 | 9.52%                           |
| 10-19     | 29.66%                                | 38.10%                          |
| 20-29     | 27.97%                                | 9.52%                           |
| 30-39     | 22.56%                                | 0.00%                           |
| 40-49     | 24.86%                                | 9.52%                           |
| 50-59     | 24.82%                                | 38.10%                          |
| 60-69     | 24.55%                                | 47.62%                          |
| 70+       | 38.25%                                | 19.05%                          |

### Interpretation of Results

The cohort identified from clinical notes is substantially older than the cohort identified from structured prescription data. This strongly suggests that the pattern matching is capturing clinical conversations that are not direct prescriptions. For example, clinicians may be discussing or ruling out the drug for older patients with comorbidities, or noting patient questions about the treatment. This reveals the clinical reasoning process but does not accurately reflect who is actually receiving the drug, leading to a skewed demographic profile.

---

## 5. Conclusion: Which Source is More Reliable?

For the specific research question of **identifying patients who have definitively received a drug**, this analysis demonstrates that **structured EHR data is the more reliable source**.

The significant discrepancies in both cohort size and age distribution highlight the inherent ambiguity of natural language. Simple pattern matching is unable to discern context, such as negation or speculative discussion. While clinical notes are an invaluable source for understanding clinical context and capturing data not available in structured fields, they are a "noisier" and less precise tool for factual cohort identification. The structured data, though lacking narrative context, provides a more accurate and verifiable record of the prescription event itself.

---

## 6. How to Reproduce This Analysis

This analysis was performed in its entirety within the **UCSF RAE environment** using **Microsoft Azure Data Studio** to execute T-SQL queries. The following steps provide a detailed guide for complete reproduction.

#### **Step 1: Establish RAE Connection**
Before running any queries, ensure you have an active and authenticated connection to the UCSF Research Data Assets SQL Server within Azure Data Studio. This is the foundational environment for all subsequent steps.

#### **Step 2: Generate and Persist the Base Cohort**
The first task is to create the comprehensive list of all patients with a Vitiligo diagnosis. This is accomplished by running the `initial_cohort_query.sql` script. This query uses a series of temporary tables and joins to identify the patient population and saves the final list into a permanent table for later use.

* **Action:** Execute the full script from `initial_cohort_query.sql`.
* **Key SQL Snippet:** The final action of this script saves the results.
    ```sql
    ...
    SELECT person_id, start_date, end_date
    INTO dbo.my_vitiligo_cohort
    FROM final_cohort;
    ```
* **Result:** A permanent table named `dbo.my_vitiligo_cohort` is created, containing the 5,209 `person_id`s that form the basis of our analysis.

#### **Step 3: Run the Main Analysis Script**
The core of this milestone is encapsulated in the `final_analysis.sql` script. This single, efficient query performs the patient sampling, pattern matching, and demographic table generation in one execution. It is structured using Common Table Expressions (CTEs) to ensure the logic is clear and performance is optimized.

* **Action:** Execute the full script from `final_analysis.sql`.
* **Breakdown of the Script's Logic:**
    1.  **Patient Sampling:** A random sample of 200 patients is selected from the permanent cohort table created in Step 2.
        ```sql
        WITH PatientSample AS (
            SELECT TOP 200 person_id
            FROM dbo.my_vitiligo_cohort
            ORDER BY NEWID()
        ),
        ```
    2.  **Pattern Matching:** The script joins the patient sample to the notes tables and performs a text search using the `LIKE` operator on a pre-filtered, smaller set of notes to improve performance.
        ```sql
        PatientsWithDrugMentions AS (
            SELECT DISTINCT person_id FROM SampledNotes
            WHERE (note_text LIKE '%opzelura%' OR note_text LIKE '%ruxolitinib%')
        ),
        ```
    3.  **Demographic Table Generation:** A final CTE combines the full cohort and the new notes-based cohort. Then, using conditional aggregation, the query pivots the data to produce the final summary table with percentages.
        ```sql
        SELECT
            "Age Range",
            -- Calculates percentage for the 'Full Cohort'
            CAST(100.0 * COUNT(CASE WHEN a.cohort_name = 'Full Cohort' ... END) AS decimal(5, 2)) AS "Full Cohort (%)",
            -- Calculates percentage for the 'Pattern Match Cohort'
            CAST(100.0 * COUNT(CASE WHEN a.cohort_name = 'Pattern Match Cohort' ... END) AS decimal(5, 2)) AS "Pattern Match Cohort (%)"
        FROM ...
        ```

#### **Step 4: View and Export Final Results**
Once the `final_analysis.sql` script has finished executing, the final demographic comparison table will be displayed in the results panel of Azure Data Studio.

* **Action:** Right-click anywhere within the results panel, select the "Save as CSV" option, and save the file to your local machine. This file contains the data needed for the final report.

## 7. Dependencies

* Access to the UCSF Research Analysis Environment (RAE).
* A SQL client capable of connecting to the RAE SQL Server (e.g., Microsoft Azure Data Studio).
